# -*- encoding: UTF-8 -*-
desc "导出评论，投票数据"
task :export_comments_and_votes_count => :environment  do

	start_time = ENV["start"]
	end_time = ENV["end"]

	CSV.open("#{Rails.root}/lib/data/export_data/#{Time.now.to_date}_comm_vote_info.csv", "wb") do |csv|
			csv << ['用户ID','姓名','邮箱', '角色', '评论数', '投票数']
			User.find_each do |user|
				csv << [user.id, user.display_name, user.email, user.role_chn_name, user.comments.where(:created_at => start_time..end_time).size, user.votes.where(:created_at => start_time..end_time).size]
			end
	end
end

desc "导出元旦活动用户"
task :export_new_year_active => :environment  do
  user_id = []
  image_id = [167121,167122,167123,167124,167125,167126,167127,167128,167129,167130,167131,167132,167133,167134,167135,167136,167137,167138,167139,167140,167141,167142,167143,167144,167145,167146,167147,167148,167149,167150,167151,167152,167153,167154,167155,167156,167157,167158,167159,167160,167161,167162,167163,167164,167165,167166,167167,167168,167169,167170,167171,167172,167173,167174,167175,167176,167177,167178,167179,167180,167181,167182,167183,167184,167185,167186,167187,167188,167189,167190,167191,167192,167193,167194,167195,167196,167197,167198,167199,167200,167201,167202,167203,167204,167205,167206,167207,167208,167209,167210,167211,167212,167213,167214,167215,167216,167217,167218,167219,167220,167221,167222,167223,167224,167225,167226,167227,167228,167229,167230,167231,167232,167233,167234,167235,167236,167237,167238,167239,167240,167241,167242,167243,167244,167245,167246,167247,167248,167249,167250,167251,167252,167253,167254,167255,167256,167257,167258,167259,167260,167261,167262,167263,167264,167265,167266,167267,167268,167269,167270,167271,167272,167273,167274,167275,167276,167277,167278,167279,167280,167281,167282,167283,167284,167285,167286,167287,167288,167289,167290,167291,167292,167293,167294,167295,167296,167297,167298,167299,167300,167301,167302,167303,167304,167305,167306,167307,167308,167309,167310,167311,167312,167313,167314,167315,167316,167317,167318,167319,167320,167321,167322,167323,167324,167325,167326,167327,167328,167329,167330,167331,167332,167333,167334,167335,167336,167337,167338,167339,167340,167341,167342,167343,167344,167345,167346,167347,167348,167349,167350,167351,167352,167353,167354,167355,167356,167357,167358,167359,167360,167361,167362,167364,167365,167366,167367,167368,167369,167370,167371,167372,167373,167374,167376,167377,167378,167380,167381,167382,167383,167384,167385,167387,167388,167389,167390,167391,167392,167393,167394,167395,167396,167397,167398,167399,167400,167401,167402,167403,167404,167405,167406,167407,167408,167409,167410,167411,167412,167413,167414,167415,167416,167417,167418,167419,167420,167421,167422,167423,167424,167425,167426,167427,167428,167429,167430,167431,167432,167433,167434,167435,167436,167437,167438,167439,167440,167441,167442,167443,167444,167445,167446,167447,167448,167449,167450,167451,167452,167453,167454,167455,167456,167457,167458,167459,167460,167461,167462,167463,167464,167465,167466,167467,167468,167469,167470,167471,167472,167473,167474,167475,167476,167477,167478,167479,167480,167481,167482,167483,167484,167485,167486,167487,167488,167489,167490,167491,167492,167493,167494,167495,167496,167497,167498,167499,167500,167501,167502,167503,167504,167505,167506,167507,167508,167509,167510,167511,167512,167513,167514,167515,167516,167517,167518,167519,167520,167521,167522,167523,167524,167525,167526,167527,167528,167529,167530,167531,167532,167533,167534,167535,167536,167537,167538,167539,167540,167541,167542,167543,167544,167545,167546,167547,167548,167549,167550,167551,167552,167553,167554,167555,167556,167557,167558,167559,167560,167561,167562,167563,167564,167565,167566,167567,167568,167569,167570,167571,167572,167573,167574,167575,167576,167577,167578,167579,167580,167581,167582,167583,167584,167585,167586,167587,167588,167589,167590,167591,167592,167593,167594,167595,167596,167597,167598,167599,167600,167601,167602,167603,167604,167605,167606,167607,167608,167609,167610,167611,167612,167613,167614,167615,167616,167617,167618,167619,167620,167621,167622,167623,167624,167625,167626,167627,167628,167629,167630,167631,167632,167633,167634,167635,167636,167637,167638,167639,167640,167641,167642,167643,167644,167645,167646,167647,167648,167649,167650,167651,167652,167653,167654,167655,167656,167657,167658,167659,167660,167661,167662,167663,167664,167665,167666,167667,167668,167669,167670,167671,167672,167673,167674,167675,167676,167677,167678,167679,167680,167681,167682,167683,167684,167685,167686,167687,167688,167689,167690,167691,167692,167693,167694,167695,167696,167697,167698,167699,167700,167701,167702,167703,167704,167705,167706,167707,167708,167709,167710,167711,167712,167713,167714,167715,167716,167717,167718,167719,167720,167721,167722,167723,167724,167725,167726,167727,167728,167729,167730,167731,167732,167733,167734,167735,167736,167737,167738,167739,167740,167741,167742,167743,167744,167745,167746,167747,167748,167749,167750,167751,167752,167753,167754,167755,167756,167757,167758,167759,167760,167761,167762,167763,167764,167765,167766,167767,167768,167769,167770,167771,167772,167773,167774,167775,167776,167777,167778,167779,167780,167781,167782,167783,167784,167785,167786,167787,167788,167789,167790,167791,167792,167793,167794,167795,167796,167797,167798,167799,167800,167801,167802,167803,167804,167805,167806,167807,167808,167809,167810,167811,167812,167813,167814,167815,167816,167817,167818,167819,167820,167821,167822,167823,167824,167825,167826,167827,167828,167829,167830,167831,167832,167833,167834,167835,167836,167837,167838,167839,167840,167841,167842,167843,167844,167845,167846,167847,167848,167849,167850,167851,167852,167853,167854,167855,167856,167857,167858,167859,167860,167861,167862,167863,167864,167865,167866,167867,167868,167869,167870,167871,167872,167873,167874,167875,167876,167877,167878,167879,167880,167881,167882,167883,167884,167885,167886,167887,167888,167889,167890,167891,167892,167893,167894,167895,167896,167897,167898,167899,167900,167901,167902,167903,167904,167905,167906,167907,167908,167909,167910,167911,167912,167913,167914,167915,167916,167917,167918,167919,167920,167921,167922,167923,167924,167925,167926,167927,167928,167929,167930,167931,167932,167933,167934,167935,167936,167937,167938,167939,167940,167941,167942,167943,167944,167945,167946,167947,167948,167949,167950,167951,167952,167953,167954,167955,167956,167957,167958,167959,167960,167961,167962,167963,167964,167965,167966,167967,167968,167969,167970,167971,167972,167973,167974,167975,167976,167977,167978,167979,167980,167981,167982,167983,167984,167985,167986,167987,167988,167989,167990,167991,167992,167993,167994,167995,167996,167997,167998,167999,168000,168001,168002,168003,168004,168005,168006,168007,168008,168009,168010,168011,168012,168013,168014,168015,168016,168017,168018,168019,168020,168021,168022,168023,168024,168025,168026,168027,168028,168029,168030,168031,168032,168033,168034,168035,168036,168037,168038,168039,168040,168041,168042,168043,168044,168045,168046,168047,168048,168049,168050,168051,168052,168053,168054,168055,168056,168057,168058,168059,168060,168061,168062,168063,168064,168065,168066,168067,168068,168069,168070,168071,168072,168073,168074,168075,168076,168077,168078,168079,168080,168081,168082,168083,168084,168085,168086,168087,168088,168089,168090,168091,168092,168093,168094,168095,168096,168097,168098,168099,168100,168101,168102,168103,168104,168105,168106,168107,168108,168109,168110,168111,168112,168113,168114,168115,168116,168117,168118,168119,168120,168121,168122,168123,168124,168125,168126,168127,168128,168129,168130,168131,168132,168133,168134,168135,168136,168137,168138,168139,168140,168141,168142,168143,168144,168145,168146,168147,168148,168149,168150,168151,168152,168153,168154,168155,168156,168157,168158,168159,168160,168161,168162,168163,168164,168165,168166,168167,168168,168169,168170,168171,168172,168173,168174,168175,168176,168177,168178,168179,168180,168181,168182,168183,168184,168185,168186,168187,168188,168189,168190,168191,168192,168193,168194,168195,168196,168197,168198,168199,168200,168201,168202,168203,168204,168205,168206,168207,168208,168209,168210,168211,168212,168213,168214,168215,168216,168217,168218,168219,168220,168221,168222,168223,168224,168225,168226,168227,168228,168229,168230,168231,168232,168233,168234,168235,168236,168237,168238,168239,168240,168241,168242,168243,168244,168245,168246,168247,168248,168249,168250,168251,168252,168253,168254,168255,168256,168257,168258,168259,168260,168261,168262,168263,168264,168265,168266,168267,168268,168269,168270,168271,168272,168273,168274,168275,168276,168277,168278,168279,168280,168281,168282,168283,168284,168285,168286,168287,168288,168289,168290,168291,168292,168293,168294,168295,168296,168297,168298,168299,168300,168301,168302,168303,168304,168305,168306,168307,168308,168309,168310,168311,168312,168313,168314,168315,168316,168317,168318,168319,168320,168321,168322,168323,168324,168325,168326,168327,168328,168329,168330,168331,168332,168333,168334,168335,168336,168337,168338,168339,168340,168341,168342,168343,168344,168345,168346,168347,168348,168349,168350,168351,168352,168353,168354,168355,168356,168357,168358,168359,168360,168361,168362,168363,168364,168365,168366,168367,168368,168369,168370,168371,168372,168373,168374,168375,168376,168377,168378,168379,168380,168381,168382,168383,168384,168385,168386,168387,168388,168389,168390,168391,168392,168393,168394,168395,168396,168397,168398,168399,168400,168401,168402,168403,168404,168405,168406,168407,168408,168409,168410,168411,168412,168413,168414,168415,168416,168417,168418,168419,168420,168421,168422,168423,168424,168425,168426,168427,168428,168429,168430,168431,168432,168433,168434,168435,168436,168437,168438,168439,168440,168441,168442,168443,168444,168445,168446,168447,168448,168449,168450,168451,168452,168453,168454,168455,168456,168457,168458,168459,168460,168461,168462,168463,168464,168465,168466,168467,168468,168469,168470,168471,168472,168473,168474,168475,168476,168477,168478,168479,168480,168481,168482,168483,168484,168485,168486,168487,168488,168489,168490,168491,168492,168493,168494,168495,168496,168497,168498,168499,168500,168501,168502,168503,168504,168505,168506,168507,168508,168509,168510,168511,168512,168513,168514,168515,168516,168517,168518,168519,168520,168521,168522,168523,168524,168525,168526,168527,168528,168529,168530,168531,168532,168533,168534,168535,168536,168537,168538,168539,168540,168541,168542,168543,168544,168545,168546,168547,168548,168549,168550,168551,168552,168553,168554,168555,168556,168557,168558,168559,168560,168561,168562,168563,168564,168565,168566,168567,168568,168569,168570,168571,168572,168573,168574,168575,168576,168577,168578,168579,168580,168581,168582,168583,168584,168585,168586,168587,168588,168589,168590,168591,168592,168593,168594,168595,168596,168597,168598,168599,168600,168601,168602,168603,168604,168605,168606,168607,168608,168609,168610,168611,168612,168613,168614,168615,168616,168617,168618,168619,168620,168621,168622,168623,168624,168625,168626,168627,168628,168629,168630,168631,168632,168633,168634,168635,168636,168637,168638,168639,168640,168641,168642,168643,168644,168645,168646,168647,168648,168649,168650,168651,168652,168653,168654,168655,168656,168657,168658,168659,168660,168661,168662,168663,168664,168665,168666,168667,168668,168669,168670,168671,168672,168673,168674,168675,168676,168677,168678,168679,168680,168681,168682,168683,168684,168685,168686,168687,168688,168689,168690,168691,168692,168693,168694,168695,168696,168697,168698,168699,168700,168701,168702,168703,168704,168705,168706,168707,168708,168709,168710,168711,168712,168713,168714,168715,168716,168717,168718,168719,168720,168721,168722,168723,168724,168725,168726,168727,168728,168729,168730,168731,168732,168733,168734,168735,168736,168737,168738,168739,168740,168741,168742,168743,168744,168745,168746,168747,168748,168749,168750,168751,168752,168753,168754,168755,168756,168757,168758,168759,168760,168761,168762,168763,168764,168765,168766,168767,168768,168769,168770,168771,168772,168773,168774,168775,168776,168777,168778,168779,168780,168781,168782,168783,168784,168785,168786,168787,168788,168789,168790,168791,168792,168793,168794,168795,168796,168797,168798,168799,168800,168801,168802,168803,168804,168805,168806,168807,168808,168809,168810,168811,168812,168813,168814,168815,168816,168817,168818,168819,168820,168821,168822,168823,168824,168825,168826,168827,168828,168829,168830,168831,168832,168833,168834,168835,168836,168837,168838,168839,168840,168841,168842,168843,168844,168845,168846,168847,168848,168849,168850,168851,168852,168853,168854,168855,168856,168857,168858,168859,168860,168861,168862,168863,168864,168865,168866,168867,168868,168869,168870,168871,168872,168873,168874,168875,168876,168877,168878,168879,168880,168881,168882,168883,168884,168885,168886,168887,168888,168889,168890,168891,168892,168893,168894,168895,168896,168897,168898,168899,168900,168901,168902,168903,168904,168905,168906,168907,168908,168909,168910,168911,168912,168913,168914,168915,168916,168917,168918,168919,168920,168921,168922,168923,168924,168925,168926,168927,168928,168929,168930,168931,168932,168933,168934,168935,168936,168937,168938,168939,168940,168941,168942,168943,168944,168945,168946,168947,168948,168949,168950,168951,168952,168953,168954,168955,168956,168957,168958,168959,168960,168961,168962,168963,168964,168965,168966,168967,168968,168969,168970,168971,168972,168973,168974,168975,168976,168977,168978,168979,168980,168981,168982,168983,168984,168985,168986,168987,168988,168989,168990,168991,168992,168993,168994,168995,168996,168997,168998,168999,169000,169001,169002,169003,169004,169005,169006,169007,169008,169009,169010,169011,169012,169013,169014,169015,169016,169017,169018,169019,169020,169021,169022,169023,169024,169025,169026,169027,169028,169029,169030,169031,169032,169033,169034,169035,169036,169037,169038,169039,169040,169041,169042,169043,169044,169045,169046,169047,169048,169049,169050,169051,169052,169053,169054,169055,169056,169057]
  design_images = DesignImage.where("created_at > '2013-12-31 00:00:00' and created_at < '2014-01-03 00:00:00'")
  design_images.each do |di|
    unless image_id.include?(di.id.to_i)
      user_id << di.user_id
    end
  end
  votes = Vote.where("created_at > '2013-12-31 00:00:00' and created_at < '2014-01-03 00:00:00' and user_id is not null and voteable_type = 'Design'")
  votes.each do |vote|
    user_id << vote.user_id
  end
  comments = Comment.where("created_at > '2013-12-31 00:00:00' and created_at < '2014-01-03 00:00:00' and user_id is not null and commentable_type = 'Design'")
  comments.each do |comments|
    user_id << comments.user_id
  end
  user_id = user_id.uniq

  CSV.open("#{Rails.root}/lib/data/#{Time.now.to_date}_new_year_active.csv", "wb") do |csv|
    csv << ['城市', '用户名', '真实姓名','邮箱地址', '联系电话', '收件地址', '转发数', '评论数', '投票数']
    users = User.where("id in (?)", user_id)
    users.each do |user|
      area_name = user.try(:city).try(:name)
      comment_count = user.comments.where("created_at > '2013-12-31 00:00:00' and created_at < '2014-01-03 00:00:00'").size
      vote_count = user.votes.where("created_at > '2013-12-31 00:00:00' and created_at < '2014-01-03 00:00:00'").size
      csv << [area_name, user.username, user.name, user.email, user.phone, user.recipient_address, 0, comment_count, vote_count]
    end
  end
end
