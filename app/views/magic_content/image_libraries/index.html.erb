<%- content_for :tail do %>
  <%= stylesheet_link_tag "image_libraries" %>
  <%= javascript_include_tag 'twitter/bootstrap'%>

  <script type="text/javascript" >
    $(function(){
      $('.set_name').click(function(e){
        $(this).siblings('.name_form').show()
      })
      $('.set_color').click(function(e){
        $(this).siblings('.color_form').show()
      })
      $('.color_commit').click(function(){
        // console.log($(this).parents('tr').html())
        if ($(this).parent().siblings('fieldset').children('input').val() == ''){
        alert('请至少在第一行输入一个色号!');
        return false;
        }
        var $input_parent = $(this).parent().siblings('fieldset')
        var $input1 = $input_parent.children('.color_input').val();
        var $input2 = $input_parent.children('.color_input2').val();
        var $input3 = $input_parent.children('.color_input3').val();
        if ($input1 == $input2 || $input1 == $input3 || ($input2 != '' && $input2 == $input3)){
        alert('不能输入相同色号');
        return false;
        }
      })
      $('.name_commit').click(function(){
        if ($(this).parent().siblings('fieldset').children('input').val() == ''){
        alert('请输入名称');
        return false;
      }
      })
      $('.js-close').click(function(){
        $(this).parents('form').hide();
      })
      $('.color_input').typeahead({
        source: function(query, process){
          $.get('/admin/content/design_images/autocomplete', {num: query}, function(data){
             process(data)
           })
        }
      })
      $('.color_input2').typeahead({
        source: function(query, process){
          $.get('/admin/content/design_images/autocomplete', {num: query}, function(data){
             process(data)
           })
        }
      })
      $('.color_input3').typeahead({
        source: function(query, process){
          $.get('/admin/content/design_images/autocomplete', {num: query}, function(data){
             process(data)
           })
        }
      })
    });
  </script>
<%- end %>
<div class="content">
  <div class="title">
    <h5>图库管理</h5>
  </div>
      
  <div class="widget first" style="position:relative;">
    <%=form_tag main_app.image_libraries_path, :method=>:get, :class=>"search_form" do %>
      <%=select_tag :genre, options_for_select([["选择筛选条件",""],["图片名称","title"],["图片作者","username"],["已被管理员修改过的图片","yes_update"],["未被管理员修改过的图片","no_update"],["图片ID","id"],["所属频道","imageable_type"],["按修改管理员","last_user_id"]], params[:genre]), :style=>"width: 200px;"%>
      <%=text_field_tag :keywords, params[:keywords], :placeholder => '输入筛选内容', :class => 'search_input'%>
      <input type='submit' class="button basicBtn" value='筛选'/>
    <% end %>
    <div class="head">
      <h5 class="iFrames">图库列表</h5>
    </div>

    <table cellpadding="0" cellspacing="0" width="100%" class="tableStatic">
      <thead>
        <th width='30px'>ID</th>
        <th>名称</th>
        <th width='60px'>列表页图片</th>
        <th>所属相册</th>
        <th width='120px'>发布时间</th>
        <th>最后修改人</th>
        <th width='120px'>最后修改时间</th>
        <th>所属频道</th>
        <th>所属用户</th>
        <th width='35px'>审核?</th>
        <th width='260px'>操作</th>
      </thead>
      <tbody>
        <%- @images.each do |image| -%>
        <tr>
          <td><%= image.id %></td>
          <td><%= truncate(image.title, length: 20) %></td>
          <td><%= image_tag(image.file(:thumb), size: '50x50', class: 'image-thumbnail') %></td>
          <td>&nbsp;</td>
          <td><%= image.created_at.strftime("%Y-%m-%d %H:%M") %></td>
          <td><%= image.last_user.username if image.last_user %></td>
          <td><%= image.last_updated_at.strftime("%Y-%m-%d %H:%M") if image.last_updated_at %></td>
          <td><%= image.channel_name %></td>
          <td><%= image.user.username %></td>
          <td><%= image.audited? ? 'Y' : 'N' %></td>
          <td>
            <%= link_to '编辑', main_app.user_designs_path(image.user.id) %>
            <%= link_to '设置名称', "javascript:void(0)", :class => 'set_name', :"data-id" => image.id %>
            <!-- <a href="javascript:void(0)" class="set_name" >设置名称</a>  -->
            <%= link_to '设置标签', '' %>
            <%= link_to '设置色号', "javascript:void(0)", :class => 'set_color', :"data-id" => image.id %>
            <%= link_to '审核', main_app.audited_image_library_path(image), :confirm => "确认审核通过吗"%>
            <%= link_to '删除', main_app.delete_image_image_library_path(image,image_id: image.id), method: :delete, :confirm => "确定删除吗" %>
            <%= render partial: 'name', :locals => { :image => image }%>
            <%= render partial: 'color', :locals => { :image => image }%>
          </td>
        </tr>
        <%- end -%>
      </tbody>
    </table>
  </div>
  <%= paginate @images if @images.present? %>
</div>
